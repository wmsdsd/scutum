!function(u){u.fn.ganttView=function(){var e=Array.prototype.slice.call(arguments);1===e.length&&"object"==typeof e[0]&&function(e){var a=this,i=u.extend(!0,{highlightWeekends:!0,highlightToday:!0,togglableProjects:!0,cellWidth:20,slideWidth:400,kineticScroll:!0,startDate:!1,endDate:!1,startToday:!1,behavior:{clickable:!1,draggable:!0,resizable:!0}},e);i.data?t():i.dataUrl&&u.getJSON(i.dataUrl,function(e){i.data=e,t()});function t(){var e=Math.floor(i.slideWidth/i.cellWidth+5),t=f.getBoundaryDatesFromData(i.data,e);i.start=i.startDate?moment(i.startDate,"MM/DD/YYYY")._d:t[0],i.end=i.endDate?moment(i.endDate,"MM/DD/YYYY")._d:t[1],a.each(function(){var e=u(this),t=u("<div>",{class:"ganttview"});new n(t,i).render(),e.append(t);u("div.ganttview-vtheader",e).outerWidth(),u("div.ganttview-slide-container",e).outerWidth();new s(e,i).apply()})}}.call(this,e[0]),2===e.length&&"string"==typeof e[0]&&function(e,t){if("setSlideWidth"===e){var a=$("div.ganttview",this);a.each(function(){var e=$("div.ganttview-vtheader",a).outerWidth();$(a).width(e+t+1),$("div.ganttview-slide-container",this).width(t)})}}.call(this,e[0],e[1])};var n=function(d,r){function w(e,t,a){var i={name:t.name};u.extend(i,a),e.data("block-data",i)}return{render:function(){!function(e,t){for(var a=u("<div>",{class:"ganttview-vtheader"}),i=0;i<t.length;i++){var n=u("<div>",{class:"ganttview-vtheader-group"});n.append(u("<div>",{class:"ganttview-vtheader-group-name",id:"groupId_"+i}).append(t[i].name).append("<span/>"));for(var s=u("<div>",{class:"ganttview-vtheader-series"}),d=0;d<t[i].series.length;d++){var r=u("<div>",{class:"ganttview-vtheader-series-row"});if(t[i].series[d].sub_series){var o=u("<div>",{class:"series-content"}),l=u("<div>",{class:"series-dates"}),v=u("<div>",{class:"series-users"});o.append('<div class="series-name">'+t[i].series[d].name+"</div>");for(var c=0;c<t[i].series[d].sub_series.length;c++){var g=0<c?'<span class="date-sep">|</span>':"",h=t[i].series[d].sub_series[c];if(h.user_avatar){var p=u("<div>",{class:"series-user"}),m=h.user_name,w=h.user_avatar;p.append('<span><img src="'+w+'" alt="'+m+'" title="'+m+'"/></span>'),v.append(p),r.append(v)}l.append(function(){return g+"<span data-event-id='"+t[i].series[d].sub_series[c].id+"'>"+moment(h.start,"MM/DD/YYYY").format("D MMM")+" - "+moment(h.end,"MM/DD/YYYY").format("D MMM")+"</span>"}),o.append(l),r.append(o)}}else r.append(function(){var e=t[i].series[d].user_avatar?"<div class='series-user'><span><img src='"+t[i].series[d].user_avatar+"' alt='"+t[i].series[d].user_name+"' title='"+t[i].series[d].user_name+"'/></span></div>":"";return e+"<div class='series-content'><div class=\"series-name\">"+t[i].series[d].name+"</div><div class='series-dates'><span data-event-id='"+t[i].series[d].id+"'>"+moment(t[i].series[d].start,"MM/DD/YYYY").format("D MMM")+" - "+moment(t[i].series[d].end,"MM/DD/YYYY").format("D MMM")+"</span></div></div>"});s.append(r)}n.append(s),a.append(n)}e.append(a)}(d,r.data);var e,t,a,i,n=u("<div>",{class:"ganttview-slide-container"}),s=function(e,t){var a=[];a[e.getFullYear()]=[],a[e.getFullYear()][e.getMonth()]=[e];for(var i=e;moment(t).isAfter(i);){var n=moment(i).add(1,"days")._d;a[n.getFullYear()]||(a[n.getFullYear()]=[]),a[n.getFullYear()][n.getMonth()]||(a[n.getFullYear()][n.getMonth()]=[]),a[n.getFullYear()][n.getMonth()].push(n),i=n}return a}(r.start,r.end);!function(e,t,a,i,n,s){var d=u("<div>",{class:"ganttview-hzheader"}),r=u("<div>",{class:"ganttview-hzheader-months"}),o=u("<div>",{class:"ganttview-hzheader-days"}),l=0;for(var v in t)for(var c in t[v]){var g=t[v][c].length*a;for(var h in l+=g,r.append(u("<div>",{class:"ganttview-hzheader-month",css:{width:g-1+"px"}}).append(moment(parseInt(c)+1,"M").format("MMMM")+" "+v)),t[v][c]){var p=u("<div>",{class:"ganttview-hzheader-day"});f.isWeekend(t[v][c][h])&&i&&p.addClass("ganttview-weekend"),moment(t[v][c][h]).isSame(Date.now(),"day")&&n&&p.addClass("ganttview-today"),moment(t[v][c][h]).isSame(Date.now(),"day")&&s&&p.addClass("ganttview-startToday"),o.append(p.append(t[v][c][h].getDate()))}}r.css("width",l+"px"),o.css("width",l+"px"),d.append(r).append(o),e.append(d)}(n,s,r.cellWidth,r.highlightWeekends,r.highlightToday,r.startToday),function(e,t,a,i,n,s){var d=u("<div>",{class:"ganttview-grid"}),r=u("<div>",{class:"ganttview-grid-row"});for(var o in a)for(var l in a[o])for(var v in a[o][l]){var c=u("<div>",{class:"ganttview-grid-row-cell"});f.isWeekend(a[o][l][v])&&n&&c.addClass("ganttview-weekend"),moment(a[o][l][v]).isSame(Date.now(),"day")&&s&&c.addClass("ganttview-today"),r.append(c)}var g=u("div.ganttview-grid-row-cell",r).length*i;r.css("width",g+"px"),d.css("width",g+"px");for(var h=0;h<t.length;h++){d.append(u("<div>",{class:"ganttview-grid-spacer","data-click-target":"groupId_"+h}));for(var p=0;p<t[h].series.length;p++)d.append(r.clone().addClass("groupId_"+h))}e.append(d)}(n,r.data,s,r.cellWidth,r.highlightWeekends,r.highlightToday),function(e,t){for(var a=u("<div>",{class:"ganttview-blocks"}),i=0;i<t.length;i++){a.append(u("<div>",{class:"ganttview-block-spacer"}));for(var n=0;n<t[i].series.length;n++)a.append(u("<div>",{class:"ganttview-block-container groupId_"+i}))}e.append(a)}(n,r.data),function(e,r,o,l){for(var v=u("div.ganttview-blocks div.ganttview-block-container",e),c=0,g=0;g<r.length;g++)for(var t=0;t<r[g].series.length;t++){if(r[g].series[t].sub_series){var h=r[g].series[t].sub_series,p=r[g].series[t].name.replace(/(<([^>]+)>)/gi," ");$.each(h,function(e,t){var a=f.daysBetween(t.start,t.end)+1,i=f.daysBetween(l,t.start),n=t.user_name?" ("+t.user_name+")":"",s=u("<div>",{class:"ganttview-block",title:p+n,"data-id":t.id,id:"ganttview-item-"+t.id,css:{width:a*o-7+"px",left:i*o+3+"px"}});w(s,r[g],h[e]),t.color&&s.css("background-color",t.color);var d=t.title?t.link?'<a href="'+t.link+'" title="'+t.link+'">'+t.title+"</a>":t.title:moment.duration(a,"days").format();t.link?s.append(u("<div>",{class:"ganttview-block-text"}).html(d)):s.append(u("<div>",{class:"ganttview-block-text"}).text(d)),u(v[c]).append(s)})}else{var a=r[g].series[t],i=a.name.replace(/(<([^>]+)>)/gi," "),n=f.daysBetween(a.start,a.end)+1,s=f.daysBetween(l,a.start),d=u("<div>",{class:"ganttview-block",title:i,id:"ganttview-item-"+r[g].series[t].id,css:{width:n*o-7+"px",left:s*o+3+"px"}});w(d,r[g],a),r[g].series[t].color&&d.css("background-color",r[g].series[t].color);var m=a.title?a.link?'<a href="'+a.link+'" title="'+a.link+'">'+a.title+"</a>":a.title:moment.duration(n,"days").format();a.link?d.append(u("<div>",{class:"ganttview-block-text"}).html(m)):d.append(u("<div>",{class:"ganttview-block-text"}).text(m)),u(v[c]).append(d)}c++}u(".ganttview-blocks").css({width:$(e).width()})}(n,r.data,r.cellWidth,r.start),d.append(n),u(d).find(".ganttview-blocks").width(n.find(".ganttview-grid").width()),e=d.parent(),u("div.ganttview-grid-row div.ganttview-grid-row-cell:last-child",e).addClass("last"),u("div.ganttview-hzheader-days div.ganttview-hzheader-day:last-child",e).addClass("last"),u("div.ganttview-hzheader-months div.ganttview-hzheader-month:last-child",e).addClass("last"),r.togglableProjects&&(t=d,a=[.55,0,.1,1],$("div.ganttview-vtheader-group-name",t).addClass("toggle_enabled").on("click",function(){var e=$(this).attr("id");$(this).hasClass("projectHidden")?($(this).removeClass("projectHidden").next("div").children().velocity("slideDown",{duration:180,easing:a}),$(".ganttview-block-container."+e).show(),$(".ganttview-grid-row."+e).velocity("slideDown",{duration:180,easing:a})):($(this).addClass("projectHidden").next("div").children().velocity("slideUp",{duration:180,easing:a}),$(".ganttview-block-container."+e).hide(),$(".ganttview-grid-row."+e).velocity("slideUp",{duration:180,easing:a}))}),$("div.ganttview-grid-spacer",t).on("click",function(){$("#"+$(this).attr("data-click-target")).click()})),r.kineticScroll&&(i=u("div.ganttview-slide-container",d),$(i).kinetic({y:!1,filterTarget:function(e,t){return!($(e).closest(".ganttview-block").length||$(e).closest(".ganttview-grid-spacer").length)}})),r.startToday&&setTimeout(function(){var e=f.daysBetween(r.start,moment()._d);n.scrollLeft(e*r.cellWidth)},100)}}},s=function(v,c){function g(e,t,a,i){var n=u("div.ganttview-slide-container",e),s=n.scrollLeft(),d=t.offset().left-n.offset().left-1+s,r=Math.round(d/a),o=moment(i).add(r,"days");t.data("block-data").start=o;var l=t.outerWidth(),v=Math.round(l/a)-1;t.data("block-data").end=moment(o).add(v,"days"),t.data("block-data").title||u("div.ganttview-block-text",t).text(moment.duration(v+1,"days").format())}return{apply:function(){var e,t,a,i,n,s,d,r,o,l;c.behavior.clickable&&(e=v,t=c.behavior.onClick,u("div.ganttview-block",e).on("click",function(){t&&t(u(this).data("block-data"))})),c.behavior.resizable&&(a=v,i=c.cellWidth,n=c.start,s=c.behavior.onResize,u("div.ganttview-block",a).resizable({grid:i,handles:"e,w",stop:function(){var e=u(this);g(a,e,i,n);var t=e.data("block-data");a.find("[data-event-id="+t.id+"]").text(moment(t.start).format("D MMM")+" - "+moment(t.end).format("D MMM")),s&&s(e.data("block-data"))}})),c.behavior.draggable&&(d=v,r=c.cellWidth,o=c.start,l=c.behavior.onDrag,u("div.ganttview-block",d).draggable({axis:"x",grid:[r,r],containment:"parent",stop:function(){var e=u(this);g(d,e,r,o);var t=e.data("block-data");d.find("[data-event-id="+t.id+"]").text(moment(t.start).format("D MMM")+" - "+moment(t.end).format("D MMM")),l&&l(e.data("block-data"))}}))}}},f={daysBetween:function(e,t){return e&&t?(e=Date.parse(e),t=Date.parse(t),1901==moment(e)._d.getYear()||8099==moment(t)._d.getYear()?0:moment(t).diff(moment(e),"days")):0},isWeekend:function(e){return e.getDay()%6==0},getBoundaryDatesFromData:function(e,t){var n=new Date,s=new Date,a=[];return e.forEach(function(e){e.series.forEach(function(e){e.sub_series?e.sub_series.forEach(function(e){a.push(e)}):a.push(e)})}),a.forEach(function(e,t){var a=Date.parse(e.start),i=Date.parse(e.end);0===t&&(n=a,s=i),moment(n).isAfter(a)&&(n=a),moment(s).isBefore(i)&&(s=i)}),moment(s).diff(n,"days")<t&&(s=moment(n).add(t,"days")),[moment(n)._d,moment(s)._d]}}}(jQuery);